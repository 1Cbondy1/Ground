<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Project 1</title>
  <!-- Styling -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="../css/reset.css">
  <!-- Materialize CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Custom Styling -->
  <link rel="stylesheet" type="text/css" href="../css/style.css">
  <!-- firebase database -->
  <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>
</head>
<body>
    <!-- Navbar -->
  <nav>
    <div class="container">
      <div class="nav-wrapper">
        <a href="#!" class="brand-logo">Donate</a>
        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <ul class="right hide-on-med-and-down">
          <li><a href="index.html">Home</a></li>
          <li><a href="donate.html">Donate</a></li>
          <li><a href="pickup.html">Pick-up</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Sidenav menu -->
  <ul class="sidenav" id="mobile-demo">
    <div class="sidenav-header">
      <h3>Ground</h3>
    </div>
    <li><a href="index.html"><i class="material-icons">home</i>Home</a></li>
    <li><a href="donate.html"><i class="material-icons">place</i>Donate</a></li>
    <li><a href="pickup.html"><i class="material-icons">directions_car</i>Pick-up</a></li>
    <li><div class="divider"></div></li>
  </ul>

  <!-- Main content -->
  <div id="search-show">
    <div class="container">
      <div class="row">
        <p id="text-info-search">What is the name of your business?</p>
      </div>
      <div class="row">
        <nav id="nav-search">
          <div class="container nav-wrapper">
            <form>
              <div class="input-field">
                <input id="search-business" type="search" autocomplete="off" required>
                <label class="label-icon" for="search-business">
                  <i class="material-icons">search</i>
                </label>
                <i class="material-icons">close</i>
              </div>
            </form>
          </div>
        </nav>
      </div>
      <div id="text-info-search" class="row">
        <p id="results">Results appear here...</p>
      </div>
    </div>
  </div>

  <!-- Business Profile -->
  <div id="profile-show">
    <div id="img-result"></div>
    <div class="container">
        <div class="row">
            <div class="col s12 m12">
                <div class="card darken-1">
                    <div class="card-content text-info-light">
                        <span id="results-profile"></span>
                    </div>
                <div class="card-action">
                <p class="waves-effect waves-light btn" id="donate-button">Donate!</p>
            </div>
        </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script src="../js/databaseHandler.js"></script>

  <script type="text/javascript">
    /* This is needed for the sidenav, because materialize? */
    $(document).ready(function(){
      $('.sidenav').sidenav();
    });

    /* This is the current buisiness that we want to add to the database. */
    var currentBiz;

    /* This is responsible for showing the relevent divs based on what we pass it. */
    function showElement(x){
      var searchShow = document.getElementById("search-show");
      var profileShow = document.getElementById("profile-show");

      searchShow.style.display = "none";
      profileShow.style.display = "none";

      if(x == 0){
        profileShow.style.display = "block";
      } else if(x == 1){
        searchShow.style.display = "block";
      }
    }

    /* This is what gets triggered when we click on the buisiness we want to add after we search. */
    function clickFunction(newBiz) {
      event.preventDefault();
      showElement(0);
      currentBiz = newBiz;
      $("#results-profile").html('<p class="text-info-light" id="' + newBiz.name + '" style="margin-top:10px;margin-bottom:10px;"><b>' + newBiz.name + '</b><br>' + newBiz.address + ' ' + newBiz.city + ', ' + newBiz.state + ' ' + newBiz.zipCode + '<br>' + newBiz.phone + '</p></div>');
      $('#img-result').html('<img id="img-profile" src="' + newBiz.imageUrl + '">');
    }

    /* Look at this unwieldly monster! Looks like a job for refactory man! This does the yelp ajax call and adds the relevent data from that call. */
    $("form").submit(function( event ) {
      //businesses = [];
      $('#results').empty();
      event.preventDefault();
      var business = $("#search-business").val().trim();
      var myurl = "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?location=austin&limit=3&term=" + business;
        $.ajax({
            url: myurl,
            headers: {
            'Authorization':'Bearer Uensef7YvWBDrkLIVTvHbF1RPf2IN989gIxMN9HEvEV8VyXjp4TZ_V8faI3tItTCrIheVIeD-XjS78gcmrmtJ9I0MvJ1kEjU6x1KzdaiUzynr8rMEwSVs9WUlrXlW3Yx',
        },
            method: 'GET',
            dataType: 'json',
            success: function(data){
                var totalresults = data.total;
                if (totalresults > 0){
                    $.each(data.businesses, function(i, item) {
                      var newBiz = new BusinessInfo(item.name, item.location.address1, item.location.city, item.location.state, item.location.zip_code, item.display_phone, item.image_url, item.coordinates.latitude, item.coordinates.longitude);

                      var container = $("<div>");
                      container.on ("click", function(){
                        clickFunction(newBiz);
                      });

                      container.html('<p class="text-results" id="' + newBiz.name + '" style="margin-top:10px;margin-bottom:10px;"><b>' + newBiz.name + '</b><br>' + newBiz.address + ' ' + newBiz.city + ', ' + newBiz.state + ' ' + newBiz.zipCode + '<br>' + newBiz.phone + '</p></div>');

                      $("#results").append(container);
                      $("#search-business").val("");
                    });
                } else {
                    $('#results').append('<p class="text-info-light">We discovered no results!</p>');
                }
              }
          });
    });

    /* This is supposed to interact with the databaseHandler.js, and add a new ref for the request to donate. */
    $("#donate-button").on("click", function() {
      var id = (new Date()).getTime();
      var fireVar = new databaseObjRef(id);
      databaseSetValue(id, "name", currentBiz.name);
      databaseSetValue(id, "address", currentBiz.address);
      databaseSetValue(id, "city", currentBiz.city);
      databaseSetValue(id, "state", currentBiz.state);
      databaseSetValue(id, "zipCode", currentBiz.zipCode);
      databaseSetValue(id, "phone", currentBiz.phone);
      databaseSetValue(id, "imageUrl", currentBiz.imageUrl);
      databaseSetValue(id, "lat", currentBiz.lat);
      databaseSetValue(id, "long", currentBiz.long);
      console.log(currentBiz.lat);
      console.log(currentBiz.long);
      fireVar.addMe();
      window.location = "pickup.html";
    });

    /* This constructor is what we use to easily pass information about a business with. */
    var BusinessInfo = function(){
      this.name = arguments[0] || "N/A";
      this.address = arguments[1] || "N/A";
      this.city = arguments[2] || "N/A";
      this.state = arguments[3] || "N/A";
      this.zipCode = arguments[4] || "N/A";
      this.phone = arguments[5] || "N/A";
      this.imageUrl = arguments[6] || "N/A";
      this.lat = arguments[7] || "N/A";
      this.long = arguments[8] || "N/A";
    }



    showElement(1);
  </script>
  </body>

</html>
